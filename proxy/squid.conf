# =============================================================================
# Squid Configuration for Claude Code Network Filtering
# =============================================================================
#
# This configuration restricts outbound access to only the domains
# required for Claude Code to function properly.
#
# =============================================================================

# Basic settings
http_port 3128
visible_hostname claude-proxy

# Access control lists
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# SSL ports that are allowed for CONNECT method
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# Load allowed domains from file (using regex matching for subdomain support)
acl allowed_domains dstdom_regex "/etc/squid/allowed-domains.txt"

# Deny requests to non-safe ports
http_access deny !Safe_ports

# Deny CONNECT to non-SSL ports
http_access deny CONNECT !SSL_ports

# Allow localhost
http_access allow localhost

# Allow connections to whitelisted domains only
http_access allow localnet allowed_domains

# Deny everything else
http_access deny all

# Logging: write to files (proxy user can't write to /dev/stdout). Entrypoint tails these to stdout/stderr.
# Format: timestamp | ALLOWED/DENIED | client_ip | method | destination_url | HTTP_status | bytes
logformat monitor %tl | %Ss | %>a | %rm | %ru | %>Hs | %<st
access_log daemon:/var/log/squid/access.log monitor
cache_log /var/log/squid/cache.log

# Minimal caching (we don't need to cache much)
cache_mem 64 MB
maximum_object_size 10 MB
cache_dir ufs /var/spool/squid 100 16 256

# Timeouts
connect_timeout 30 seconds
read_timeout 60 seconds
request_timeout 60 seconds

# Don't add forwarded-for header (privacy)
forwarded_for off

# Suppress version in error pages
httpd_suppress_version_string on

# Shutdown settings
shutdown_lifetime 5 seconds
